#This file contains functions to format prediction results and group data
#into predicted numbers of people in the group of each vaccination status

# library(tidyverse)
# library(lubridate)

#'A function to transform the predicted proportions of each Location, Region, and Age
#'along with number of individuals into the predicted number of each vaccinated status.
#'@description A function to transform vaccination proportion and group data into numbers of each status.
#'@param pop_data A data frame with information on the group. Needs to have Location, Region, Age, and Number of People.
#'@param prediction_data A data frame with the predicted vaccination proportion from each Date, Location, Region, and Age in pop_data. Needs to have Date, Location, Region, Age,
#'Portion_1, Proportion_2, and upper and lower bounds on Proportion_1 and Proportion_2, named Proportion_1_lower , Proportion_1_upper, Proportion_2_lower, and Proportion_2_upper, if uncertainty = TRUE.
#'@param uncertainty A logical singleton indicating if estimated confidence intervals are required
#'@return A data frame with predicted numbers and proportions of group members with each vaccination status,
#'grouped by Location, Region, and Age. This data frame also contains upper and lower bounds if uncertainty is TRUE
get_results <- function(pop_data,prediction_data, uncertainty=TRUE){
  N <- sum(pop_data$`Number of People`)
  prediction_data %>%
    inner_join(pop_data)%>%
    group_by(Location,Region,Age)%>%
    group_modify(function(data,key){
      data <- data %>% filter(Date == max(Date))
      
      if(uncertainty){
        return(tibble(
          Date=max(data$Date),
          Number_fully = data$Portion_2 * data$`Number of People`,
          Number_fully_lower = data$Portion_2_lower * data$`Number of People`,
          Number_fully_upper = data$Portion_2_upper * data$`Number of People`,
          Proportion_fully = Number_fully/N,
          Proportion_fully_lower = Number_fully_lower/N,
          Proportion_fully_upper = Number_fully_upper/N,
          
          Number_partially = (data$Portion_1-data$Portion_2)*data$`Number of People`,
          Number_partially_lower = max((data$Portion_1_lower-data$Portion_2_upper)*data$`Number of People`,0),
          Number_partially_upper = (data$Portion_1_upper-data$Portion_2_lower)*data$`Number of People`,
          Proportion_partially = Number_partially/N,
          Proportion_partially_lower=Number_partially_lower/N,
          Proportion_partially_upper=Number_partially_upper/N,
          
          Number_unvacc = (1-data$Portion_1)*data$`Number of People`,
          Number_unvacc_lower = max((1-data$Portion_1_upper)*data$`Number of People`,0),
          Number_unvacc_upper = (1-data$Portion_1_lower)*data$`Number of People`,
          Proportion_unvacc = Number_unvacc/N,
          Proportion_unvacc_lower=Number_unvacc_lower/N,
          Proportion_unvacc_upper=Number_unvacc_upper/N
        ))
      } else {
        return(tibble(
          Date=max(data$Date),
          Number_fully = data$Portion_2 * data$`Number of People`,
          Proportion_fully = Number_fully/N,
          Number_partially = (data$Portion_1-data$Portion_2)*data$`Number of People`,
          Proportion_partially = Number_partially/N,
          Number_unvacc = (1-data$Portion_1)*data$`Number of People`,
          Proportion_unvacc = Number_partially/N
        ))
      }
    }) 
}


#' A function to get the total predicted numbers and proportions of individuals with each vaccination status
#' in the entire group, along with the confidence intervals if desired.
#' @description A function that gets the total predicted numbers and proportions of individuals with each vaccination status in a group
#' @param results_data Data on the predicted results for the desired group categories, generated by the get_results function
#' @param pop_data A data frame with information on the group. Needs to have Location, Region, Age, and Number of People as variables.
#' @param uncertainty A singleton logical value indicating if this function should return confidence intervals on its estimates
#' @return A data frame with the estimated total proportions and numbers of individuals with each vaccination status, and the 
#' confidence intervals on these estimates if requested.
get_total_results <- function(results_data, pop_data, uncertainty=TRUE){
  N <- sum(pop_data$`Number of People`)
  
  total_fully_vaccinated <- sum(results_data$Number_fully)
  total_unvaccinated <- sum(results_data$Number_unvacc)
  total_partially_vaccinated <- sum(results_data$Number_partially)
  
  if(!uncertainty){
    return(tibble(
      Status=c("Unvaccinated","Partially Vaccinated","Fully Vaccinated"),
      Number=c(total_unvaccinated,total_partially_vaccinated,total_fully_vaccinated),
      Proportion=c(total_unvaccinated/N,total_partially_vaccinated/N,total_fully_vaccinated/N)
    ))
  }
  

  lower_total_fully_vaccinated <- sum(results_data$Number_fully_lower)
  lower_total_unvaccinated <-  sum(results_data$Number_unvacc_lower)
  lower_total_partially_vaccinated <- sum(results_data$Number_partially_lower)

    
  upper_total_fully_vaccinated <- sum(results_data$Number_fully_upper)
  upper_total_unvaccinated <-  sum(results_data$Number_unvacc_upper)
  upper_total_partially_vaccinated <- sum(results_data$Number_partially_upper)
  
  proportion_fully_CI <- c(max(lower_total_fully_vaccinated/N-1/sqrt(N),0),
                           min(upper_total_fully_vaccinated/N+1/sqrt(N),N))
  proportion_partially_CI <- c(max(lower_total_partially_vaccinated/N-1/sqrt(N),0),
                               min(upper_total_partially_vaccinated/N+1/sqrt(N),N))
  proportion_unvaccianted_CI <-  c(max(lower_total_unvaccinated/N-1/sqrt(N),0),
                                   min(upper_total_unvaccinated/N+1/sqrt(N),N))
  
  return(tibble(
    Status=c("Unvaccinated","Partially Vaccinated","Fully Vaccinated"),
    Number=c(total_unvaccinated,total_partially_vaccinated,total_fully_vaccinated),
    `Number Lower Bound`=c(proportion_unvaccianted_CI[1]*N,proportion_partially_CI[1]*N,proportion_fully_CI[1]*N),
    `Number Upper Bound`=c(proportion_unvaccianted_CI[2]*N,proportion_partially_CI[2]*N,proportion_fully_CI[2]*N),
    Proportion=c(total_unvaccinated/N,total_partially_vaccinated/N,total_fully_vaccinated/N),
    `Proportion Lower Bound`=c(proportion_unvaccianted_CI[1],proportion_partially_CI[1],proportion_fully_CI[1]),
    `Proportion Upper Bound`=c(proportion_unvaccianted_CI[2],proportion_partially_CI[2],proportion_fully_CI[2])
  ))
}
