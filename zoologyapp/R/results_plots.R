# library(tidyverse)
# library(lubridate)

#'A function to return the bar plot used for displaying the numbers and relative 
#'percentages of each vaccination status (full, partial, or unvaccinted),
#'along with uncertainty (if specified!) and a percent scale if desired
#'@description A function that generates a ggplot bar plot object plotting vaccination status predictions
#'@param results_data A data frame with the predicted vaccination composition of the population by category, as generated by get_results
#'@param total_data A data frame with the total predicted vaccination statuses for the entire group, as generated by get_total_results()
#'@param uncertainty A logical singleton indicating if error bars are desired
#'@param percent A logical singleton indicating if the graphed values should be rescaled to percent of the entire group size
#'@param return A ggplot object bar plot with the numbers or relative percentages of each vaccination status for the entire group and per category of individual

result_bar_plot <- function(results_data,total_data,default_option,uncertainty,percent){
  certain_plot <- NULL
  
  if(percent){
    certain_plot <- results_data %>%
      ungroup()%>%
      categorize(.,default_option)%>%
      tidyr::pivot_longer(
        cols=c(Proportion_fully,Proportion_partially,Proportion_unvacc)
      )%>% 
      inner_join(tibble(
        name=c("Proportion_fully","Proportion_partially","Proportion_unvacc"),
        group=c("Fully Vaccinated","Partially Vaccinated","Unvaccinated")
      ))%>%
      mutate(group=factor(group,levels=c("Unvaccinated","Partially Vaccinated","Fully Vaccinated")))%>%
      ggplot(aes(x=group,y=value*100,fill=factor(Category)))+geom_bar(position="stack",stat="identity")+
      xlab("")+ylab("Percent of Group")+ylim(0,100)
  } else{
    certain_plot <- results_data %>%
      ungroup()%>%
      categorize(.,default_option)%>%
      tidyr::pivot_longer(
        cols=c(Number_fully,Number_partially,Number_unvacc)
      )%>% 
      inner_join(tibble(
        name=c("Number_fully","Number_partially","Number_unvacc"),
        group=c("Fully Vaccinated","Partially Vaccinated","Unvaccinated")
      ))%>%
      mutate(group=factor(group,levels=c("Unvaccinated","Partially Vaccinated","Fully Vaccinated")))%>%
      ggplot(aes(x=group,y=value,fill=factor(Category)))+geom_bar(position="stack",stat="identity")+
      xlab("")+ylab("Number of People")
  }
  certain_plot <- certain_plot + theme_bw()+theme(legend.title=element_blank())+
    scale_fill_viridis_d()+coord_cartesian(expand=FALSE)
  if(!uncertainty){
    return(certain_plot)
  }
  
  if(percent){
    return(
      certain_plot + 
        geom_errorbar(data=total_data,aes(x=factor(Status),ymin=`Proportion Lower Bound`*100,ymax=`Proportion Upper Bound`*100),
                      inherit.aes = FALSE,size=1.2)
    )
  } else {
    ymax <- max(total_data$`Number Upper Bound`*1.1)
    return(
      certain_plot + 
        geom_errorbar(data=total_data,aes(x=factor(Status),ymin=`Number Lower Bound`,ymax=`Number Upper Bound`),
                      inherit.aes=FALSE,size=1.2)+ylim(0,ymax)
    )
  }
  

}
